<template>
  <div id="app">
    <!-- Î∞∞ÎÑà ÏàòÏ†ï ÏòÅÏó≠ -->
    <div class="content-below-banner">
      <div v-if="isEditing">
        <input
          v-model="bannerTitle"
          class="banner-input"
          placeholder="Î∞∞ÎÑà Ï†úÎ™©"
        />
        <textarea
          v-model="bannerContent"
          class="banner-textarea"
          rows="3"
          placeholder="Î∞∞ÎÑà ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ï§ÑÎ∞îÍøà Í∞ÄÎä•)"
        />
        <div class="edit-actions">
          <button class="save-btn" @click="saveBanner">Ï†ÄÏû•</button>
          <button class="cancel-btn" @click="cancelEdit">Ï∑®ÏÜå</button>
        </div>
      </div>
      <div v-else>
        <h6><strong>{{ bannerTitle }}</strong></h6>
        <p class="banner-paragraph">
          {{ bannerContent }}
          <q-btn
            v-if="userInfo.role === 'DEV' || userInfo.role === 'ADMIN'"
            icon="edit"
            flat
            round
            dense
            color="primary"
            @click="startEdit"
            class="inline-edit-btn"
          />
        </p>
      </div>
    </div>

    <!-- Í≥µÏßÄÏÇ¨Ìï≠ Î≥∏Î¨∏ -->
    <header class="main-container">
      <q-card class="q-pa-md" style="max-width: 1000px; margin: 0 auto;">
        <q-list bordered separator>
          <q-expansion-item
            v-for="notice in paginatedNotices"
            :key="notice.id"
            expand-icon="mdi-chevron-down"
            expanded-icon="mdi-chevron-up"
            class="notice-item"
            expand-icon-class="text-primary q-mr-sm"
          >
            <template v-slot:header>
              <q-item-section avatar v-if="!notice.isPinned">
                <q-badge color="indigo" class="q-pa-sm">
                  {{ paginatedNotices.filter(n => !n.isPinned).findIndex(n => n.id === notice.id) + 1 }}
                </q-badge>
              </q-item-section>
              <q-item-section class="text-left">
                <q-item-label class="text-weight-medium">
                  {{ notice.isPinned ? 'üìå ' + notice.title : notice.title }}
                </q-item-label>
                <q-item-label caption class="q-mt-xs">üë§ {{ notice.name }}</q-item-label>
              </q-item-section>
              <q-item-section side class="items-center">
                <span class="notice-date">üóìÔ∏è {{ notice.date }}</span>
              </q-item-section>
              <q-item-section v-if="userInfo.role === 'DEV' || userInfo.role === 'ADMIN'" side>
                <div class="row no-wrap items-center q-gutter-x-sm">
                  <q-btn flat dense icon="edit" @click.stop="openEditDialog(notice)" />
                  <q-btn flat dense icon="delete" color="negative" @click.stop="deleteNotice(notice.id)" />
                </div>
              </q-item-section>
            </template>
            <q-card class="q-pa-sm notice-content">
              <p>üì¢ {{ notice.content }}</p>
            </q-card>
          </q-expansion-item>
        </q-list>

        <div class="row q-mt-md items-center justify-between">
          <div class="col-auto q-mx-auto">
            <q-pagination
              v-model="pagination.page"
              :max="maxPages"
              max-pages="7"
              boundary-numbers
              direction-links
              color="primary"
            />
          </div>
          <div class="col-auto" v-if="userInfo.role === 'DEV' || userInfo.role === 'ADMIN'">
            <q-btn icon="edit" label="Í∏ÄÏì∞Í∏∞" color="primary" @click="dialogVisible = true" />
          </div>
        </div>
      </q-card>

      <!-- Í∏ÄÏì∞Í∏∞ Îã§Ïù¥ÏñºÎ°úÍ∑∏ -->
      <q-dialog v-model="dialogVisible" persistent>
        <q-card style="min-width: 900px; max-width: 1100px;">
          <q-card-section class="q-pa-lg">
            <div class="text-h6 q-mb-md">üìù Í≥µÏßÄÏÇ¨Ìï≠ ÏûëÏÑ±</div>
            <q-input v-model="newTitle" label="Ï†úÎ™©" class="q-mb-md" />
            <q-input
              v-model="newContent"
              label="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
              type="textarea"
              autogrow
              class="q-mb-md"
              :style="{ minHeight: '200px' }"
            />
            <q-checkbox v-model="newPinned" label="üìå ÏÉÅÎã® Í≥†Ï†ï" class="q-mt-sm" />
          </q-card-section>
          <q-card-actions align="right" class="q-pa-md">
            <q-btn flat label="‚ùå Îã´Í∏∞ (ESC)" @click="dialogVisible = false" />
            <q-btn flat label="‚úÖ Ï†ÄÏû•" color="primary" @click="addNotice" />
          </q-card-actions>
        </q-card>
      </q-dialog>

      <!-- ÏàòÏ†ï Îã§Ïù¥ÏñºÎ°úÍ∑∏ -->
      <q-dialog v-model="editDialogVisible" persistent>
        <q-card style="min-width: 900px; max-width: 1100px;">
          <q-card-section class="q-pa-lg">
            <div class="text-h6 q-mb-md">‚úèÔ∏è Í≥µÏßÄÏÇ¨Ìï≠ ÏàòÏ†ï</div>
            <q-input v-model="editTitle" label="Ï†úÎ™©" class="q-mb-md" />
            <q-input
              v-model="editContent"
              label="ÎÇ¥Ïö©ÏùÑ ÏàòÏ†ïÌïòÏÑ∏Ïöî"
              type="textarea"
              autogrow
              class="q-mb-md"
              :style="{ minHeight: '200px' }"
            />
            <q-checkbox v-model="editPinned" label="üìå ÏÉÅÎã® Í≥†Ï†ï" class="q-mt-sm" />
          </q-card-section>
          <q-card-actions align="right" class="q-pa-md">
            <q-btn flat label="Îã´Í∏∞" @click="editDialogVisible = false" />
            <q-btn flat label="ÏàòÏ†ï ÏôÑÎ£å" color="primary" @click="updateNotice" />
          </q-card-actions>
        </q-card>
      </q-dialog>
    </header>
  </div>
</template>

<script>
import { ref, computed, getCurrentInstance, onMounted } from 'vue'
import { api } from 'boot/axios.js'
import { useUserStore } from 'stores/userStore'
import { storeToRefs } from 'pinia'

export default {
  setup() {
    // Î∞∞ÎÑà ÏàòÏ†ï ÏÉÅÌÉú
    const bannerTitle = ref('Maglo - Í≥µÏßÄÏÇ¨Ìï≠')
    const bannerContent = ref('ÏÑúÎπÑÏä§ÏôÄ Í¥ÄÎ†®Îêú Ï£ºÏöî Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÎäî Í≥µÍ∞ÑÏûÖÎãàÎã§.')
    const isEditing = ref(false)

    const userStore = useUserStore()
    const { userInfo } = storeToRefs(userStore)
    const { proxy } = getCurrentInstance()
    const showDialog = msg => proxy.$q.dialog({ title: 'ÏïåÎ¶º üì¢', message: msg, ok: 'ÌôïÏù∏' })

    const fetchBanner = async () => {
      try {
        const res = await api.get('/api/v1/banner', { params: { page: 'notice' } })
        bannerTitle.value = res.data.title
        bannerContent.value = res.data.description1
      } catch { /* empty */ }
    }
    const saveBanner = async () => {
      try {
        await api.put(
          '/api/v1/banner/update',
          { title: bannerTitle.value, description1: bannerContent.value, description2: '' },
          { params: { page: 'notice' } }
        )
        isEditing.value = false
        showDialog('‚úÖ Î∞∞ÎÑàÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.')
      } catch {
        showDialog('‚ùå Î∞∞ÎÑà Ï†ÄÏû• Ïã§Ìå®')
      }
    }
    const startEdit = () => (isEditing.value = true)
    const cancelEdit = () => { isEditing.value = false; fetchBanner() }
    onMounted(fetchBanner)

    // Í≥µÏßÄÏÇ¨Ìï≠ ÏÉÅÌÉú
    const notices = ref([])
    const pagination = ref({ page: 1, rowsPerPage: 15 })
    const dialogVisible = ref(false)
    const editDialogVisible = ref(false)
    const newTitle = ref('')
    const newContent = ref('')
    const newPinned = ref(false)
    const editId = ref(null)
    const editTitle = ref('')
    const editContent = ref('')
    const editPinned = ref(false)

    const fetchNotices = async () => {
      try {
        const res = await api.get('/api/v1/boards/all-boards')
        const sorted = res.data.sort((a, b) => {
          if (a.isPinned && !b.isPinned) return -1
          if (!a.isPinned && b.isPinned) return 1
          return new Date(b.createdAt) - new Date(a.createdAt)
        })
        notices.value = sorted.map(notice => {
          const d = new Date(notice.createdAt)
          const days = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†']
          return {
            ...notice,
            date: `${d.toLocaleDateString('ko-KR')} (${days[d.getDay()]}) ${d.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'})}`
          }
        })
      } catch (e) {
        showDialog(e.response?.data?.message || '‚ùå Í≥µÏßÄÏÇ¨Ìï≠ Ï°∞Ìöå Ïã§Ìå®.')
      }
    }

    const addNotice = async () => {
      if (!newTitle.value || !newContent.value) return showDialog('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.')
      try {
        await api.post('/api/v1/boards/create', { title: newTitle.value, content: newContent.value, isPinned: newPinned.value })
        dialogVisible.value = false
        newTitle.value = ''
        newContent.value = ''
        newPinned.value = false
        await fetchNotices()
        showDialog('‚úÖ Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.')
      } catch {
        showDialog('‚ùå Ï†ÄÏû• Ïã§Ìå®')
      }
    }

    const openEditDialog = notice => {
      editId.value = notice.id
      editTitle.value = notice.title
      editContent.value = notice.content
      editPinned.value = notice.isPinned
      editDialogVisible.value = true
    }

    const updateNotice = async () => {
      if (!editTitle.value || !editContent.value) return showDialog('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.')
      try {
        await api.put(`/api/v1/boards/${editId.value}`, { title: editTitle.value, content: editContent.value, isPinned: editPinned.value })
        editDialogVisible.value = false
        await fetchNotices()
        showDialog('üîÑ Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.')
      } catch {
        showDialog('‚ùå ÏàòÏ†ï Ïã§Ìå®')
      }
    }

    const deleteNotice = async id => {
      proxy.$q.dialog({ title: 'üóëÔ∏è ÏÇ≠Ï†ú ÌôïÏù∏', message: '‚ö†Ô∏è Ïù¥ Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?', cancel: true, ok: 'ÏÇ≠Ï†ú' })
        .onOk(async () => {
          await api.delete(`/api/v1/boards/${id}`)
          await fetchNotices()
          showDialog('üóëÔ∏è Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.')
        })
    }

    const maxPages = computed(() => Math.ceil(notices.value.length / pagination.value.rowsPerPage))
    const paginatedNotices = computed(() => {
      const start = (pagination.value.page - 1) * pagination.value.rowsPerPage
      return notices.value.slice(start, start + pagination.value.rowsPerPage)
    })

    // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    fetchNotices()

    return {
      bannerTitle, bannerContent, isEditing, startEdit, cancelEdit, saveBanner,
      notices, pagination, dialogVisible, editDialogVisible,
      newTitle, newContent, newPinned, editId, editTitle, editContent, editPinned,
      paginatedNotices, maxPages, openEditDialog, addNotice, updateNotice, deleteNotice,
      userInfo
    }
  }
}
</script>

<style scoped>
/* Î∞∞ÎÑà Ïä§ÌÉÄÏùº */
.content-below-banner {
  position: relative;
  top: 200px;
  left: 0;
  width: 100%;
  padding: 10px;
  background: #fff;
  max-width: 1000px;
  margin: 0 auto;
  text-align: left;
  font-family: Arial, sans-serif;
  color: #333;
  z-index: 10;
}
.banner-input, .banner-textarea { width: 100%; padding: 8px; margin-bottom: 6px; border: 1px solid #ccc; border-radius:4px }
.edit-actions { margin-top:6px }
.save-btn { background:#4CAF50;color:#fff;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;margin-right:6px }
.cancel-btn { background:#ccc;color:#333;padding:6px 12px;border:none;border-radius:4px;cursor:pointer }
.inline-edit-btn { position: relative; z-index:11; cursor:pointer }
.banner-paragraph { white-space: pre-wrap }

/* Í≥µÏßÄÏÇ¨Ìï≠ Ïä§ÌÉÄÏùº */
#app { font-family:Avenir,Helvetica,Arial,sans-serif; color:#2c3e50; text-align:center }
* { font-family:'Nanum Gothic',sans-serif }
.main-container { width:69.6%; margin:250px auto 200px; text-align:center; padding-bottom:120px }
.notice-item { cursor:pointer; transition:background .2s }
.notice-item:hover { background:#f5f5f5 }
.notice-date { font-size:13px; color:#777; margin-right:10px }
.notice-content { padding:50px; text-align:left; background:#fafafa; border-left:3px solid #1976d2; border-radius:4px }
.notice-content p { margin:0; line-height:1.6; white-space: pre-wrap }
</style>
