<template>
  <q-page class="page-container">
    <!-- ÏÉÅÎã® ÏïàÎÇ¥ Î∞∞ÎÑà -->
    <div class="content-below-banner">
      <h6><strong>Maglo - Ïú†Ï†Ä ÌÜµÌï© Í¥ÄÎ¶¨</strong></h6>
      <p>Ïú†Ï†ÄÏùò Í∞ÄÏûÖ ÏöîÏ≤≠ ÎòêÎäî Ïû¨ÏäπÏù∏ ÏöîÏ≤≠ÏùÑ ÏäπÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
    </div>

    <!-- ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
    <q-tabs
      v-model="activeTab"
      class="tabs-container"
      dense
      align="justify"
      indicator-color="primary"
    >
      <q-tab name="pros" label="üë§ ÌîÑÎ°ú Ïú†Ï†Ä Í¥ÄÎ¶¨" />
      <q-tab v-if="isDev" name="admins" label="üõ† Í¥ÄÎ¶¨Ïûê Ïú†Ï†Ä Í¥ÄÎ¶¨" />
    </q-tabs>

    <q-separator />

    <q-tab-panels v-model="activeTab" animated>
      <!-- ÌîÑÎ°ú Ïú†Ï†Ä Í¥ÄÎ¶¨ -->
      <q-tab-panel name="pros">
        <q-card flat bordered class="card-container">
          <q-card-section>
            <!-- Í≤ÄÏÉâ Î∞è ÏÉÅÌÉú ÌïÑÌÑ∞ -->
            <div class="row q-gutter-md q-mb-md">
              <q-input
                v-model="searchName"
                label="üîç Ïù¥Î¶Ñ Í≤ÄÏÉâ"
                dense
                debounce="300"
                outlined
                clearable
                class="col"
              />
              <q-select
                v-model="filterStatus"
                :options="statusFilterOptions"
                emit-value
                option-label="label"
                option-value="value"
                :display-value="filterStatus ? statusMap[filterStatus] : ''"
                label="üóÇ ÏÉÅÌÉú ÌïÑÌÑ∞"
                dense
                outlined
                clearable
                class="col"
              />
            </div>

            <q-table
              :rows="sortedPros"
              :columns="columns"
              row-key="id"
              flat
              dense
              hide-bottom
              :pagination="{ rowsPerPage: 30 }"
            >
              <!-- Ïù¥Î¶Ñ Ïò§Î•∏Ï™ΩÏóê ÏÉÅÌÉú DOT -->
              <template v-slot:body-cell-name="props">
                <q-td :props="props">
                  <div class="row items-center q-gutter-xs">
                    <span>{{ props.row.name }}</span>
                    <q-icon
                      name="circle"
                      :color="statusDotColorMap[props.row.status] || 'grey'"
                      size="10px"
                    />
                  </div>
                </q-td>
              </template>

              <template v-slot:body-cell-email="props">
                <q-td :props="props">{{ props.row.email }}</q-td>
              </template>
              <template v-slot:body-cell-status="props">
                <q-td :props="props">{{ statusMap[props.row.status] || props.row.status }}</q-td>
              </template>
              <template v-slot:body-cell-role="props">
                <q-td :props="props">
                  <q-select
                    v-model="props.row.editableRole"
                    :options="getRoleOptions(props.row)"
                    dense
                    emit-value
                  />
                </q-td>
              </template>
              <template v-slot:body-cell-detail="props">
                <q-td :props="props" class="q-pa-xs">
                  <q-btn
                    flat dense
                    label="ÏÉÅÏÑ∏"
                    color="info"
                    @click.stop="openUserDetail(props.row)"
                  />
                </q-td>
              </template>
              <template v-slot:body-cell-actions="props">
                <q-td :props="props" class="actions-cell">
                  <!-- ÏäπÏù∏ -->
                  <q-btn
                    flat round dense icon="check_circle" color="primary"
                    v-if="['PENDING_APPROVAL','PENDING_REAPPROVAL','REJECTED'].includes(props.row.status)"
                    @click="approveUser(props.row.id)"
                  >
                    <q-tooltip>ÏäπÏù∏</q-tooltip>
                  </q-btn>

                  <!-- Í±∞Ï†à -->
                  <q-btn
                    flat round dense icon="block" color="negative"
                    v-if="props.row.status !== 'NORMAL'"
                    @click="rejectUser(props.row.id)"
                  >
                    <q-tooltip>Í±∞Ï†à</q-tooltip>
                  </q-btn>
                  <!-- Ïó∞Ïû• -->
                  <q-btn
                    flat round dense icon="add_alarm" color="secondary"
                    v-if="props.row.status === 'NORMAL'"
                    @click="extendUserBy7Days(props.row.id)"
                  >
                    <q-tooltip>7Ïùº Ïó∞Ïû•</q-tooltip>
                  </q-btn>

                  <!-- ÏÇ≠Ï†ú -->
                  <q-btn
                    flat round dense icon="delete" color="negative"
                    @click="deleteUser(props.row.id)"
                  >
                    <q-tooltip>ÏÇ≠Ï†ú</q-tooltip>
                  </q-btn>

                  <!-- ÎßåÎ£å -->
                  <q-btn
                    flat round dense icon="hourglass_empty" color="warning"
                    v-if="props.row.status === 'NORMAL'"
                    @click="expireUser(props.row.id)"
                  >
                    <q-tooltip>ÎßåÎ£å</q-tooltip>
                  </q-btn>
                </q-td>
              </template>
            </q-table>

            <div class="q-pa-md flex justify-center">
              <q-pagination
                v-model="paginationUsers.page"
                :max="pagesUsers"
                boundary-links
                dense
              />
            </div>
          </q-card-section>
        </q-card>
      </q-tab-panel>

      <!-- Í¥ÄÎ¶¨Ïûê Ïú†Ï†Ä Í¥ÄÎ¶¨ -->
      <q-tab-panel v-if="isDev" name="admins">
        <q-card flat bordered class="card-container">
          <q-card-section>
            <!-- Í≤ÄÏÉâ Î∞è ÏÉÅÌÉú ÌïÑÌÑ∞ -->
            <div class="row q-gutter-md q-mb-md">
              <q-input
                v-model="searchName"
                label="üîç Ïù¥Î¶Ñ Í≤ÄÏÉâ"
                dense
                debounce="300"
                outlined
                clearable
                class="col"
              />
              <q-select
                v-model="filterStatus"
                :options="statusFilterOptions"
                label="üóÇ ÏÉÅÌÉú ÌïÑÌÑ∞"
                dense
                outlined
                clearable
                class="col"
              />
            </div>

            <q-table
              :rows="sortedAdmins"
              :columns="columns"
              row-key="id"
              flat
              dense
              hide-bottom
              :pagination="{ rowsPerPage: 30 }"
            >
              <!-- ‚ë† Ïù¥Î¶Ñ Ïò§Î•∏Ï™ΩÏóê ÏÉÅÌÉú DOT -->
              <template v-slot:body-cell-name="props">
                <q-td :props="props">
                  <div class="row items-center q-gutter-xs">
                    <span>{{ props.row.name }}</span>
                    <q-icon
                      name="circle"
                      :color="statusDotColorMap[props.row.status] || 'grey'"
                      size="10px"
                    />
                  </div>
                </q-td>
              </template>

              <template v-slot:body-cell-email="props">
                <q-td :props="props">{{ props.row.email }}</q-td>
              </template>
              <template v-slot:body-cell-status="props">
                <q-td :props="props">{{ statusMap[props.row.status] || props.row.status }}</q-td>
              </template>
              <template v-slot:body-cell-role="props">
                <q-td :props="props">
                  <q-select
                    v-model="props.row.editableRole"
                    :options="getRoleOptions(props.row)"
                    dense
                    emit-value
                  />
                </q-td>
              </template>
              <template v-slot:body-cell-detail="props">
                <q-td :props="props" class="q-pa-xs">
                  <q-btn
                    flat dense
                    label="ÏÉÅÏÑ∏"
                    color="info"
                    @click.stop="openUserDetail(props.row)"
                  />
                </q-td>
              </template>
              <template v-slot:body-cell-actions="props">
                <q-td :props="props" class="actions-cell">
                  <!-- ‚úÖ Ïó≠Ìï†Ïù¥ Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ÏóêÎßå ÏäπÏù∏ Î≤ÑÌäº ÌëúÏãú -->
                  <q-btn
                    flat round dense icon="check_circle" color="primary"
                    v-if="props.row.editableRole !== props.row.originalRole"
                    @click="approveAdmin(props.row.id)"
                  >
                    <q-tooltip>ÏäπÏù∏</q-tooltip>
                  </q-btn>

                  <!-- ‚úÖ ÏÇ≠Ï†ú Î≤ÑÌäºÏùÄ Ìï≠ÏÉÅ ÌëúÏãú -->
                  <q-btn
                    flat round dense icon="delete" color="negative"
                    @click="deleteAdmin(props.row.id)"
                  >
                    <q-tooltip>ÏÇ≠Ï†ú</q-tooltip>
                  </q-btn>
                </q-td>
              </template>
            </q-table>

            <div class="q-pa-md flex justify-center">
              <q-pagination
                v-model="paginationAdmins.page"
                :max="pagesAdmins"
                boundary-links
                dense
              />
            </div>
          </q-card-section>
        </q-card>
      </q-tab-panel>
    </q-tab-panels>

    <!-- ÏÉÅÏÑ∏Ï†ïÎ≥¥ Îã§Ïù¥ÏñºÎ°úÍ∑∏ -->
    <q-dialog v-model="dialog">
      <q-card style="min-width: 1100px; max-width: 90vw;">
        <q-card-section>
          <div class="text-h6">{{ selectedUser?.name || 'Ïú†Ï†Ä ÏÉÅÏÑ∏ Ï†ïÎ≥¥' }}</div>
        </q-card-section>
        <q-separator />
        <q-card-section>
          <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
          <div class="user-detail-row">
            <div class="detail-item"><strong>Ïù¥Î©îÏùº:</strong> {{ selectedUser?.email || '-' }}</div>
            <div class="detail-item">
              <strong>ÏÉÅÌÉú:</strong> {{ statusMap[selectedUser?.status] || selectedUser?.status || '-' }}
            </div>

            <!-- ‚úÖ Í±∞Ï†à ÏÇ¨Ïú† ÌëúÏãú (REJECTED ÏÉÅÌÉúÏùº ÎïåÎßå) -->
            <div
              class="detail-item text-negative"
              v-if="selectedUser?.status === 'REJECTED' && selectedUser?.rejectReason"
            >
              <strong>Í±∞Ï†à ÏÇ¨Ïú†:</strong> {{ selectedUser.rejectReason }}
            </div>
            <div class="detail-item"><strong>Í∞ÄÏûÖÏùº:</strong> {{ formatDate(selectedUser?.createdAt) }}</div>
            <div class="detail-item"><strong>ÏäπÏù∏ IP:</strong> {{ selectedUser?.ipAddress || '-' }}</div>
            <div class="detail-item"><strong>UUID:</strong> {{ selectedUser?.deviceId || '-' }}</div>
            <div class="detail-item"><strong>ÎßåÎ£åÏùº:</strong> {{ formatDate(selectedUser?.approvedUntil) }}</div>
          </div>

          <q-separator class="q-my-md" />

          <!-- Ïó∞Ïû• UI -->
          <div class="user-detail-row">
            <div class="detail-item">
              <strong>Ïó∞Ïû• Í∏∞Í∞Ñ:</strong>
              <div class="row items-center q-gutter-xs q-mt-xs">
                <q-btn flat dense label="1Ï£º Ïó∞Ïû•" color="primary" @click="selectExtensionDays(7)" />
                <q-btn flat dense label="1Îã¨ Ïó∞Ïû•" color="primary" @click="selectExtensionDays(30)" />
                <q-input dense type="date" v-model="customDate" style="width: 150px" />
                <q-btn flat dense label="Ï†ÅÏö©" color="secondary" @click="applyExtension" />
              </div>
            </div>
            <div class="detail-item">
              <strong>ÏûêÎèô Ïó∞Ïû•:</strong>
              <div class="q-mt-xs">
                <q-checkbox
                  v-model="autoExtend"
                  label="ÏûêÎèô Ïó∞Ïû•"
                  color="green"
                  :disable="!selectedUser?.approvedUntil"
                  @update:model-value="updateAutoExtend"
                />
              </div>
            </div>
          </div>

          <q-separator class="q-my-md" />

          <!-- ÏÇ¨Ïö©Îüâ Ï†ïÎ≥¥ -->
          <div class="user-detail-row q-mb-sm">
            <div class="detail-item">
              <strong>üîç Îã®Ïùº Í≤ÄÏÉâ</strong>
              <q-checkbox
                v-model="selectedUser.canUseSingleSearch"
                @update:model-value="v => updateFeatureUsage('single', v)"
                label="ÏÇ¨Ïö© Ïó¨Î∂Ä"
              />
              <div>{{ selectedUser.canUseSingleSearch ? '‚úÖ Í∞ÄÎä•' : '‚ùå Î∂àÍ∞Ä' }}</div>
              <div>
                ÏùºÏùº Ï†úÌïú:
                <q-input
                  v-model.number="selectedUser.singleSearchLimit"
                  type="number"
                  dense
                  outlined
                  style="width: 100px"
                  @blur="updateSearchLimit('single')"
                />Ìöå
              </div>
              <div>Ïò§Îäò ÏÇ¨Ïö©: {{ selectedUser?.singleSearchUsed ?? '-' }}Ìöå</div>
              <q-btn dense flat color="negative" label="Ï¥àÍ∏∞Ìôî" size="sm" @click="resetUsage('single')" />
            </div>
            <div class="detail-item">
              <strong>üìä Îû≠ÌÇπ Í≤ÄÏÉâ</strong>
              <q-checkbox
                v-model="selectedUser.canUseRankingSearch"
                @update:model-value="v => updateFeatureUsage('ranking', v)"
                label="ÏÇ¨Ïö© Ïó¨Î∂Ä"
              />
              <div>{{ selectedUser.canUseRankingSearch ? '‚úÖ Í∞ÄÎä•' : '‚ùå Î∂àÍ∞Ä' }}</div>
              <div>
                ÏùºÏùº Ï†úÌïú:
                <q-input
                  v-model.number="selectedUser.rankingSearchLimit"
                  type="number"
                  dense
                  outlined
                  style="width: 100px"
                  @blur="updateSearchLimit('ranking')"
                />Ìöå
              </div>
              <div>Ïò§Îäò ÏÇ¨Ïö©: {{ selectedUser?.rankingSearchUsed ?? '-' }}Ìöå</div>
              <q-btn dense flat color="negative" label="Ï¥àÍ∏∞Ìôî" size="sm" @click="resetUsage('ranking')" />
            </div>

            <div class="detail-item">
              <strong>üõí ÏáºÌïë Í≤ÄÏÉâ</strong>
              <q-checkbox
                v-model="selectedUser.canUseShoppingSearch"
                @update:model-value="v => updateFeatureUsage('shopping', v)"
                label="ÏÇ¨Ïö© Ïó¨Î∂Ä"
              />
              <div>{{ selectedUser.canUseShoppingSearch ? '‚úÖ Í∞ÄÎä•' : '‚ùå Î∂àÍ∞Ä' }}</div>
              <div>
                ÏùºÏùº Ï†úÌïú:
                <q-input
                  v-model.number="selectedUser.shoppingSearchLimit"
                  type="number"
                  dense
                  outlined
                  style="width: 100px"
                  @blur="updateSearchLimit('shopping')"
                />Ìöå
              </div>
              <div>Ïò§Îäò ÏÇ¨Ïö©: {{ selectedUser?.shoppingSearchUsed ?? '-' }}Ìöå</div>
              <q-btn dense flat color="negative" label="Ï¥àÍ∏∞Ìôî" size="sm" @click="resetUsage('shopping')" />
            </div>

            <div class="detail-item">
              <strong>üìà Ìä∏Î†åÎìú Í≤ÄÏÉâ</strong>
              <q-checkbox
                v-model="selectedUser.canUseTrendSearch"
                @update:model-value="v => updateFeatureUsage('trend', v)"
                label="ÏÇ¨Ïö© Ïó¨Î∂Ä"
              />
              <div>{{ selectedUser.canUseTrendSearch ? '‚úÖ Í∞ÄÎä•' : '‚ùå Î∂àÍ∞Ä' }}</div>

              <div>
                ÏùºÏùº Ï†úÌïú:
                <q-input
                  v-model.number="selectedUser.trendSearchLimit"
                  type="number"
                  dense
                  outlined
                  style="width: 100px"
                  @blur="updateSearchLimit('trend')"
                />Ìöå
              </div>
              <div>Ïò§Îäò ÏÇ¨Ïö©: {{ selectedUser?.trendSearchUsed ?? '-' }}Ìöå</div>
              <q-btn dense flat color="negative" label="Ï¥àÍ∏∞Ìôî" size="sm" @click="resetUsage('trend')" />
            </div>


            <div class="detail-item">
              <strong>üîÅ Ïó∞Í¥ÄÍ≤ÄÏÉâ</strong>
              <q-checkbox
                v-model="selectedUser.canUseRelatedSearch"
                @update:model-value="v => updateFeatureUsage('related', v)"
                label="ÏÇ¨Ïö© Ïó¨Î∂Ä"
              />
              <div>{{ selectedUser.canUseRelatedSearch ? '‚úÖ Í∞ÄÎä•' : '‚ùå Î∂àÍ∞Ä' }}</div>
              <div>ÏùºÏùº Ï†úÌïú: Î¨¥Ï†úÌïú</div>
            </div>

            <div class="detail-item">
              <strong>üß© ÌÇ§ÏõåÎìú Ï°∞Ìï©Í∏∞</strong>
              <q-checkbox
                v-model="selectedUser.canUseKeywordMix"
                @update:model-value="v => updateFeatureUsage('mixer', v)"
                label="ÏÇ¨Ïö© Ïó¨Î∂Ä"
              />
              <div>{{ selectedUser.canUseKeywordMix ? '‚úÖ Í∞ÄÎä•' : '‚ùå Î∂àÍ∞Ä' }}</div>
              <div>ÏùºÏùº Ï†úÌïú: Î¨¥Ï†úÌïú</div>
            </div>
          </div>

          <q-separator class="q-my-md" />

          <!-- Î°úÍ∑∏ ÌÖåÏù¥Î∏î -->
          <div class="user-detail-row">
            <div class="detail-item" style="width:100%">
              <strong>üìÑ Ïú†Ï†Ä ÌôúÎèô Î°úÍ∑∏</strong>
              <div class="row q-gutter-sm q-mb-md items-end">
                <q-input v-model="logSearch.startDate" label="ÎÇ†Ïßú ÏÑ†ÌÉù" type="date" dense />
                <q-btn label="Í≤ÄÏÉâ" color="primary" @click="fetchUserLogsByDate" dense />
                <q-btn label="Ï¥àÍ∏∞Ìôî" color="negative" @click="resetLogSearch" dense />
              </div>
              <q-table
                :rows="logs"
                :columns="logColumns"
                row-key="id"
                flat
                bordered
                dense
                class="q-mt-sm"
                hide-pagination
                :pagination="{ rowsPerPage: 0 }"
                no-data-label="ÌôúÎèô Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§."
              />
              <q-btn
                dense flat
                color="primary"
                icon="cloud_download"
                label="Î°úÍ∑∏ Îã§Ïö¥Î°úÎìú (Excel)"
                class="q-mt-sm"
                @click="downloadUserLogExcel"
              />
            </div>
          </div>
        </q-card-section>

        <q-card-actions align="right">
          <q-btn flat label="Îã´Í∏∞" color="primary" v-close-popup />
        </q-card-actions>
      </q-card>
    </q-dialog>
  </q-page>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useQuasar, Dialog } from 'quasar'
import { api } from 'boot/axios'
import { useUserStore } from 'src/stores/userStore'
import { storeToRefs } from 'pinia'
import ExcelJS from 'exceljs'
import { saveAs } from 'file-saver'

const $q = useQuasar()
const userStore = useUserStore()
const { userInfo } = storeToRefs(userStore)
const isDev = computed(() => userInfo.value.role === 'DEV')
const activeTab = ref('pros')


// Í≤ÄÏÉâÏñ¥, ÏÉÅÌÉú ÌïÑÌÑ∞
const searchName = ref('')
const filterStatus = ref(null)

// ÏÉÅÌÉú Îß§Ìïë & ÌïÑÌÑ∞ ÏòµÏÖò
const statusMap = {
  PENDING_ALL:      'ÏäπÏù∏ ÎåÄÍ∏∞',
  NORMAL: 'Ï†ïÏÉÅ',
  WITHDRAWAL: 'ÌÉàÌá¥',
  PENDING_APPROVAL: 'ÏäπÏù∏ ÎåÄÍ∏∞',
  REJECTED: 'Í±∞Ï†àÎê®',
  PENDING_REAPPROVAL: 'ÏäπÏù∏ ÎåÄÍ∏∞',
  WAITING: 'ÎåÄÍ∏∞Ï§ë'
}

const statusFilterOptions = [
  { label: 'ÏäπÏù∏ ÎåÄÍ∏∞', value: 'PENDING_ALL' },
  { label: 'Ï†ïÏÉÅ',       value: 'NORMAL' },
  { label: 'Í±∞Ï†à',       value: 'REJECTED' }
]

// --- 2) Í∞Å valueÏóê Îß§ÌïëÎê† Ïã§Ï†ú ÏÉÅÌÉú Î∞∞Ïó¥ Ï∂îÍ∞Ä
const statusFilterMap = {
  PENDING_ALL:      ['PENDING_APPROVAL', 'PENDING_REAPPROVAL'],
  NORMAL:           ['NORMAL'],
  REJECTED:         ['REJECTED']
}


// ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò
const paginationUsers = ref({ page: 1, rowsPerPage: 30 })
const paginationAdmins = ref({ page: 1, rowsPerPage: 30 })

// Ïó≠Ìï† ÏòµÏÖò
const approvalRoleOptions = [
  { label: 'PRO', value: 'PRO' },
  { label: 'ADMIN', value: 'ADMIN' }
]
const adminApprovalRoleOptions = [
  { label: 'PRO', value: 'PRO' },
  { label: 'ADMIN', value: 'ADMIN' },
  { label: 'DEV', value: 'DEV' }
]
const getRoleOptions = row =>
  row.originalRole === 'ADMIN' ? adminApprovalRoleOptions : approvalRoleOptions

// Ïª¨Îüº Ï†ïÏùò
const columns = [
  { name: 'id', label: 'üÜî ID', field: 'id', align: 'left' },
  { name: 'name', label: 'üßë Ïù¥Î¶Ñ', field: 'name', align: 'left' },
  { name: 'email', label: '‚úâÔ∏è Ïù¥Î©îÏùº', field: 'email', align: 'left' },
  { name: 'createdAt', label: 'üìÖ Í∞ÄÏûÖÏùº', field: 'createdAt', align: 'left' },
  { name: 'approvedUntil', label: '‚è≥ ÎßåÎ£åÏùº', field: 'approvedUntil', align: 'left' },
  { name: 'status', label: 'üìå ÏÉÅÌÉú', field: 'status', align: 'left' },
  { name: 'detail', label: 'üîé', field: 'detail', align: 'center', sortable: false },
  { name: 'role', label: 'üéØ Ïó≠Ìï†', field: 'editableRole', align: 'left' },
  { name: 'actions', label: '‚öôÔ∏è', field: 'actions', align: 'center', sortable: false }
]

// Ï†ÑÏ≤¥ Ïú†Ï†Ä
const allUsers = ref([])

// ÌïÑÌÑ∞ÎßÅ (Í≤ÄÏÉâ + ÏÉÅÌÉú) ‚Äî ÌîÑÎ°ú Ïú†Ï†Ä
const filteredPros = computed(() => {
  return allUsers.value
    // Ïó≠Ìï†Ïù¥ PROÏù∏ Ïú†Ï†ÄÎßå
    .filter(u => u.role === 'PRO')
    // ÎåÄÍ∏∞Ï§ë(Í∞ÄÏûÖ Ï†Ñ) ÏÉÅÌÉúÎäî Ï†úÏô∏
    .filter(u => u.status !== 'WAITING')
    // Ïù¥Î¶Ñ Í≤ÄÏÉâ
    .filter(u => {
      const name = searchName.value.trim().toLowerCase()
      return !name || u.name.toLowerCase().includes(name)
    })
    // ÏÉÅÌÉú ÌïÑÌÑ∞
    .filter(u => {
      if (!filterStatus.value) {
        // ÏïÑÎ¨¥Í≤ÉÎèÑ ÏÑ†ÌÉù Ïïà ÌïòÎ©¥ Î™®Îëê ÌÜµÍ≥º
        return true
      }
      // ÏÑ†ÌÉùÎêú ÌïÑÌÑ∞Í∞íÏóê Îß§ÌïëÎêú Ïã§Ï†ú ÏÉÅÌÉú Î∞∞Ïó¥ Í∞ÄÏ†∏Ïò§Í∏∞
      const allowed = statusFilterMap[filterStatus.value] || []
      return allowed.includes(u.status)
    })
})

// ÌïÑÌÑ∞ÎßÅ (Í≤ÄÏÉâ + ÏÉÅÌÉú) ‚Äî Í¥ÄÎ¶¨Ïûê Ïú†Ï†Ä
const filteredAdmins = computed(() => {
  return allUsers.value
    // Ïó≠Ìï†Ïù¥ ADMINÏù∏ Ïú†Ï†ÄÎßå
    .filter(u => u.role === 'ADMIN')
    // ÎåÄÍ∏∞Ï§ë(Í∞ÄÏûÖ Ï†Ñ) ÏÉÅÌÉúÎäî Ï†úÏô∏
    .filter(u => u.status !== 'WAITING')
    // Ïù¥Î¶Ñ Í≤ÄÏÉâ
    .filter(u => {
      const name = searchName.value.trim().toLowerCase()
      return !name || u.name.toLowerCase().includes(name)
    })
    // ÏÉÅÌÉú ÌïÑÌÑ∞
    .filter(u => {
      if (!filterStatus.value) {
        return true
      }
      const allowed = statusFilterMap[filterStatus.value] || []
      return allowed.includes(u.status)
    })
})

// ÌéòÏù¥Ïßï
const pagesUsers = computed(() =>
  Math.ceil(filteredPros.value.length / paginationUsers.value.rowsPerPage)
)
const pagesAdmins = computed(() =>
  Math.ceil(filteredAdmins.value.length / paginationAdmins.value.rowsPerPage)
)
const paginatedUsers = computed(() =>
  filteredPros.value.slice(
    (paginationUsers.value.page - 1) * paginationUsers.value.rowsPerPage,
    paginationUsers.value.page * paginationUsers.value.rowsPerPage
  )
)
const paginatedAdmins = computed(() =>
  filteredAdmins.value.slice(
    (paginationAdmins.value.page - 1) * paginationAdmins.value.rowsPerPage,
    paginationAdmins.value.page * paginationAdmins.value.rowsPerPage
  )
)

// Ï†ïÎ†¨ (ÏÉÅÌÉú Ïö∞ÏÑ†ÏàúÏúÑ)
const statusOrder = ['PENDING_APPROVAL', 'PENDING_REAPPROVAL', 'NORMAL', 'REJECTED', 'WAITING']
const sortedPros = computed(() =>
  paginatedUsers.value.slice().sort((a, b) =>
    statusOrder.indexOf(a.status) - statusOrder.indexOf(b.status)
  )
)
const sortedAdmins = computed(() =>
  paginatedAdmins.value.slice().sort((a, b) =>
    statusOrder.indexOf(a.status) - statusOrder.indexOf(b.status)
  )
)
const statusDotColorMap = {
  NORMAL: 'green',
  REJECTED: 'red',
  WAITING: 'black',
  PENDING_APPROVAL: 'amber',
  PENDING_REAPPROVAL: 'amber'
}
// ÏÉÅÏÑ∏Ï†ïÎ≥¥ & Î°úÍ∑∏
const dialog = ref(false)
const selectedUser = ref(null)
const logs = ref([])
const logSearch = ref({ startDate: null })

const logColumns = [
  { name: 'date', label: 'üìÖ ÎÇ†Ïßú', field: 'date', align: 'center' },
  { name: 'time', label: '‚è∞ ÏãúÍ∞Ñ', field: 'time', align: 'center' },
  { name: 'name', label: 'üßë Ïù¥Î¶Ñ', field: 'name', align: 'center' },
  { name: 'ip', label: 'üåê Ï†ëÏÜç IP', field: 'ip', align: 'center' },
  { name: 'uuid', label: 'üßæ Ï†ëÏÜç UUID', field: 'uuid', align: 'center' },
  { name: 'action', label: '‚úÖ ÏÇ¨Ïö©Ìïú Í∏∞Îä•', field: 'action', align: 'center' }
]

// API Ìò∏Ï∂ú
async function fetchAllUsers() {
  const res = await api.get('/api/v1/admin/admins/all-users')
  allUsers.value = res.data.map(u => ({
    ...u,
    originalRole: u.role,
    editableRole: u.role
  }))
}

async function extendUserBy7Days(userId) {
  const user = allUsers.value.find(u => u.id === userId)
  if (!user || !user.approvedUntil) return

  const current = new Date(user.approvedUntil)
  current.setDate(current.getDate() + 7)
  const newDate = current.toISOString().split('T')[0]

  await api.put(`/api/v1/admin/users/extend/${userId}`, {
    newApprovedUntil: newDate,
    autoExtend: user.autoExtend ?? false
  })
  await fetchAllUsers()
  Dialog.create({ title: '‚úÖ Ïó∞Ïû• ÏôÑÎ£å', message: 'ÎßåÎ£åÏùºÏù¥ 7Ïùº Ïó∞Ïû•ÎêòÏóàÏäµÎãàÎã§.' })
}

// ÏäπÏù∏/Í±∞Ï†à/ÏÇ≠Ï†ú (ÌîÑÎ°ú)
async function approveUser(userId) {
  const user = allUsers.value.find(u => u.id === userId)
  await api.put(`/api/v1/admin/users/approve/${userId}`, { role: user.editableRole || user.role })
  await fetchAllUsers()
  $q.dialog({ title: '‚úÖ ÏäπÏù∏ ÏôÑÎ£å', message: 'Ïú†Ï†ÄÍ∞Ä ÏäπÏù∏ÎêòÏóàÏäµÎãàÎã§.' })
}
function rejectUser(userId) {
  $q.dialog({
    title: 'Í±∞Ï†à ÏÇ¨Ïú† ÏûÖÎ†•',
    message: 'Ïù¥ ÏÇ¨Ïö©ÏûêÎ•º Ïôú Í±∞Ï†àÌïòÏãúÎÇòÏöî?',
    prompt: { model: '', type: 'text', isValid: v => v.length > 0 },
    cancel: true
  }).onOk(async reason => {
    await api.put(`/api/v1/admin/users/reject/${userId}`, { reason })
    await fetchAllUsers()
    $q.dialog({ title: '‚ùå Í±∞Ï†à ÏôÑÎ£å', message: 'Ïú†Ï†ÄÍ∞Ä Í±∞Ï†àÎêòÏóàÏäµÎãàÎã§.' })
  })
}
function deleteUser(userId) {
  $q.dialog({
    title: 'ÏÇ≠Ï†ú ÌôïÏù∏',
    message: 'Ï†ïÎßê Ïù¥ Ïú†Ï†ÄÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?',
    cancel: true,
    persistent: true
  }).onOk(async () => {
    await api.delete(`/api/v1/admin/users/${userId}`)
    await fetchAllUsers()
    $q.dialog({ title: '‚úÖ ÏÇ≠Ï†ú ÏôÑÎ£å', message: 'Ïú†Ï†ÄÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.' })
  })
}

// ÏäπÏù∏/Í±∞Ï†à/ÏÇ≠Ï†ú (Í¥ÄÎ¶¨Ïûê)
async function approveAdmin(userId) {
  const user = allUsers.value.find(u => u.id === userId)
  const newRole = user.editableRole || user.role

  // ‚úÖ ADMIN ‚Üí PRO Í∞ïÎì± Ïãú ÎßåÎ£åÏùº 7Ïùº ÏÑ§Ï†ï
  const payload = { role: newRole }
  if (user.originalRole === 'ADMIN' && newRole === 'PRO') {
    const now = new Date()
    now.setDate(now.getDate() + 7)
    const expireDate = now.toISOString().split('T')[0]
    payload.approvedUntil = expireDate + 'T00:00:00'
    payload.autoExtend = false
  }

  await api.put(`/api/v1/admin/admins/approve/${userId}`, payload)
  await fetchAllUsers()
  $q.dialog({ title: '‚úÖ ÏäπÏù∏ ÏôÑÎ£å', message: 'Í¥ÄÎ¶¨Ïûê Ïó≠Ìï†Ïù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.' })
}


function deleteAdmin(userId) {
  $q.dialog({
    title: 'ÏÇ≠Ï†ú ÌôïÏù∏',
    message: 'Ï†ïÎßê Ïù¥ Í¥ÄÎ¶¨ÏûêÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?',
    cancel: true,
    persistent: true
  }).onOk(async () => {
    await api.delete(`/api/v1/admin/admins/${userId}`)
    await fetchAllUsers()
    $q.dialog({ title: '‚úÖ ÏÇ≠Ï†ú ÏôÑÎ£å', message: 'Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.' })
  })
}

// ÎßåÎ£å Ï≤òÎ¶¨ (Expire)
async function expireUser(userId) {
  await api.put(`/api/v1/admin/users/expire/${userId}`)
  await fetchAllUsers()
  $q.dialog({ title: '‚úÖ ÎßåÎ£å ÏôÑÎ£å', message: 'Ïú†Ï†Ä Í≥ÑÏ†ïÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.' })
}


// ÏÉÅÏÑ∏Ï†ïÎ≥¥ & Î°úÍ∑∏
function mapLogResponse(data) {
  return data.map(log => {
    const d = new Date(log.searchedAt)
    return {
      date: d.toLocaleDateString('ko-KR'),
      time: d.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
      name: log.userName || '-',
      ip: log.ipAddress || '-',
      uuid: log.uuid || '-',
      action: log.actionType || '-'
    }
  })
}
async function fetchUserLogs(userId) {
  const res = await api.get(`/api/admin/logs/user/${userId}/logs`, { params: { limit: 30 } })
  logs.value = mapLogResponse(res.data)
}
async function fetchUserLogsByDate() {
  if (!logSearch.value.startDate || !selectedUser.value?.id) {
    Dialog.create({ title: '‚ö†Ô∏è ÎÇ†Ïßú ÏÑ†ÌÉù ÌïÑÏöî', message: 'ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.' })
    return
  }
  const res = await api.get(`/api/admin/logs/user/${selectedUser.value.id}/logs`, {
    params: { startDate: logSearch.value.startDate }
  })
  logs.value = mapLogResponse(res.data)
}
function resetLogSearch() {
  logSearch.value.startDate = null
  if (selectedUser.value?.id) fetchUserLogs(selectedUser.value.id)
}
async function downloadUserLogExcel() {
  const res = await api.get(`/api/admin/logs/user/${selectedUser.value.id}/logs`, { params: { full: true } })
  const fullLogs = mapLogResponse(res.data)
  if (!fullLogs.length) {
    Dialog.create({ title: '‚ùå Î°úÍ∑∏ ÏóÜÏùå', message: 'Îã§Ïö¥Î°úÎìúÌï† Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.' })
    return
  }
  const workbook = new ExcelJS.Workbook()
  const worksheet = workbook.addWorksheet('ÏÇ¨Ïö© Î°úÍ∑∏')
  worksheet.columns = logColumns.map(col => ({
    header: col.label.replace(/^[^\w„Ñ±-Ìû£]+/, ''), key: col.field, width: 20
  }))
  fullLogs.forEach(log => worksheet.addRow(log))
  worksheet.getRow(1).font = { bold: true }
  const buffer = await workbook.xlsx.writeBuffer()
  const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' })
  saveAs(blob, `user_log_${selectedUser.value?.name || 'user'}.xlsx`)
}

function formatDate(dateStr) {
  if (!dateStr) return '-'
  return dateStr.split('T')[0] || dateStr.split(' ')[0]
}

const customDate = ref(null)
const autoExtend = ref(false)

function selectExtensionDays(days) {
  const base = new Date(selectedUser.value?.approvedUntil || new Date())
  base.setDate(base.getDate() + days)
  customDate.value = base.toISOString().split('T')[0]
}
async function applyExtension() {
  if (selectedUser.value?.status !== 'NORMAL') {
    Dialog.create({ title: '‚ö†Ô∏è ÏäπÏù∏ ÌïÑÏöî', message: 'ÏäπÏù∏Îêú ÏÇ¨Ïö©ÏûêÎßå Ïó∞Ïû•Ïù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.' })
    return
  }
  if (!customDate.value || !selectedUser.value?.id) {
    Dialog.create({ title: '‚ö†Ô∏è', message: 'ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.' })
    return
  }
  await api.put(`/api/v1/admin/users/extend/${selectedUser.value.id}`, {
    newApprovedUntil: customDate.value, autoExtend: autoExtend.value
  })
  selectedUser.value.approvedUntil = customDate.value
  selectedUser.value.autoExtend = autoExtend.value
  Dialog.create({ title: '‚úÖ Ïó∞Ïû• ÏôÑÎ£å', message: 'ÏäπÏù∏ Í∏∞Í∞ÑÏù¥ Ïó∞Ïû•ÎêòÏóàÏäµÎãàÎã§.' })
}

async function updateAutoExtend(value) {
  await api.put(`/api/v1/admin/users/extend/${selectedUser.value.id}`, {
    newApprovedUntil: selectedUser.value.approvedUntil, autoExtend: value
  })
  Dialog.create({
    title: '‚úÖ ÏûêÎèôÏó∞Ïû• Î≥ÄÍ≤Ω',
    message: value ? 'ÏûêÎèô Ïó∞Ïû•Ïù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§.' : 'ÏûêÎèô Ïó∞Ïû•Ïù¥ Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§.'
  })
}
async function resetUsage(type) {
  await api.post(`/api/search/${selectedUser.value.id}/usage/reset`, { type })
  Dialog.create({
    title: '‚úÖ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å',
    message: `${type === 'single' ? 'Îã®Ïùº Í≤ÄÏÉâ' : 'Îû≠ÌÇπ Í≤ÄÏÉâ'} ÏÇ¨Ïö©ÎüâÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.`
  })
  openUserDetail(selectedUser.value)
}

async function updateSearchLimit(type) {
  if (!selectedUser.value?.id) return
  let limit = 0

  if (type === 'single') {
    limit = selectedUser.value.singleSearchLimit
  } else if (type === 'ranking') {
    limit = selectedUser.value.rankingSearchLimit
  } else if (type === 'shopping') {
    limit = selectedUser.value.shoppingSearchLimit
  } else if (type === 'trend') {
    limit = selectedUser.value.trendSearchLimit // ‚úÖ Ìä∏Î†åÎìú Ï∂îÍ∞Ä
  }

  try {
    await api.put(`/api/v1/admin/users/${selectedUser.value.id}/usage-limit`, { type, limit })
    Dialog.create({
      title: '‚úÖ Ï†úÌïú ÏÑ§Ï†ï ÏôÑÎ£å',
      message: `${{
        single: 'Îã®Ïùº Í≤ÄÏÉâ',
        ranking: 'Îû≠ÌÇπ Í≤ÄÏÉâ',
        shopping: 'ÏáºÌïë Í≤ÄÏÉâ',
        trend: 'Ìä∏Î†åÎìú Í≤ÄÏÉâ'
      }[type]} Ï†úÌïúÏù¥ ${limit}ÌöåÎ°ú ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§.`
    })
  } catch {
    Dialog.create({ title: '‚ùå Ïò§Î•ò', message: 'Ï†úÌïú ÏÑ§Ï†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.' })
  }
}

async function openUserDetail(row) {
  const res = await api.get(`/api/v1/admin/users/${row.id}/detail`)
  const user = res.data.user
  const usage = res.data.usage

  selectedUser.value = {
    ...user,
    singleSearchLimit: usage.singleSearchLimit,
    singleSearchUsed: usage.singleSearchUsed,
    rankingSearchLimit: usage.rankingSearchLimit,
    rankingSearchUsed: usage.rankingSearchUsed,
    shoppingSearchLimit: usage.shoppingSearchLimit,    // ‚úÖ ÏáºÌïë Ï∂îÍ∞Ä
    shoppingSearchUsed: usage.shoppingSearchUsed,      // ‚úÖ ÏáºÌïë Ï∂îÍ∞Ä
    canUseShoppingSearch: usage.canUseShoppingSearch,
    canUseTrendSearch: usage.canUseTrendSearch,
    trendSearchLimit: usage.trendSearchLimit,
    trendSearchUsed: usage.trendSearchUsed, // ‚úÖ ÏáºÌïë ÏÇ¨Ïö© Ïó¨Î∂Ä Ï∂îÍ∞Ä
  }

  customDate.value = null
  autoExtend.value = selectedUser.value.autoExtend ?? false
  logSearch.value = { startDate: null }

  await fetchUserLogs(row.id)
  dialog.value = true
}

async function updateFeatureUsage(feature, enabled) {
  try {
    await api.put(`/api/v1/admin/users/${selectedUser.value.id}/feature-usage`, {
      feature,
      enabled
    })
    Dialog.create({
      title: '‚úÖ ÏÑ§Ï†ï ÏôÑÎ£å',
      message: `${{
        single: 'Îã®Ïùº Í≤ÄÏÉâ',
        ranking: 'Îû≠ÌÇπ Í≤ÄÏÉâ',
        shopping: 'ÏáºÌïë Í≤ÄÏÉâ',
        trend: 'Ìä∏Î†åÎìú Í≤ÄÏÉâ',
        related: 'Ïó∞Í¥Ä Í≤ÄÏÉâ',
        mixer: 'ÌÇ§ÏõåÎìú Ï°∞Ìï©Í∏∞'
      }[feature]} ÏÇ¨Ïö© Ïó¨Î∂ÄÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`
    })
  } catch (err) {
    console.error('Í∏∞Îä• ÏÑ§Ï†ï Ïã§Ìå®:', err)
    Dialog.create({
      title: '‚ùå Ï†ÄÏû• Ïã§Ìå®',
      message: 'Í∏∞Îä• ÏÑ§Ï†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'
    })
  }
}


onMounted(fetchAllUsers)
</script>

<style scoped>
.page-container {
  padding-top: 120px;
  max-width: 1200px;
  margin: 0 auto;
  padding-bottom: 120px;
}

.content-below-banner {
  width: 100%;
  background: #fff;
  padding: 12px 24px;
  margin-bottom: 16px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.tabs-container {
  margin-top: 0;
}

.card-container { margin: 16px 0; }
.actions-cell > .q-btn { margin: 0 4px; }
.q-table tr:hover { background-color: #f5f7fa; }

.user-detail-row {
  display: flex;
  flex-wrap: wrap;
  gap: 30px;
  margin-top: 10px;
}

.detail-item { min-width: 200px; flex: 1; }
</style>
